<!DOCTYPE html>
<html id="app">
<head>
    <title>设置</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/static/css/uikit.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <link rel="stylesheet" type="text/css" href="/static/css/simditor.css" />

    <script src="/static/js/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/vue/1.0.26/vue.min.js"></script>
    <!--script src="/static/js/vue.min.js"></script-->
    <script src="/static/js/page.js"></script>

    <script src="/static/js/module.js"></script>
    <script src="/static/js/hotkeys.js"></script>
    <script src="/static/js/uploader.js"></script>
    <script src="/static/js/simditor.js"></script>
    <!--Benjamin Shi, 2016-->
</head>
<body>
    <header class="header">
        <div class="uk-grid uk-grid-collapse">
            <div class="header-menu uk-width-medium-2-10 uk-flex uk-flex-center uk-flex-middle" v-bind:class="{'active': MENU.active}">
                <h1 class="header-menu-heading uk-h4">设置</h1>
            </div>
            <div class="header-content uk-width-medium-8-10 uk-width-1-1 uk-flex uk-flex-middle">
                <div class="uk-container uk-container-center uk-width-1-1">
                    <div class="uk-grid uk-grid-width-1-3">
                        <h1 class="uk-h4">
                            <a class="header-content-back uk-visible-small" v-on:click="MENU.active = true">
                                <i class="fa fa-chevron-left"></i> {{ HEADER.CONTENT.back }}
                            </a>
                        </h1>
                        <h1 class="header-content-heading uk-h4 uk-text-center">{{ HEADER.CONTENT.heading }}</h1>
                        <h1 class="uk-h4">
                            <a class="header-content-function" v-on:click="HEADER.CONTENT.function">
                                {{ HEADER.CONTENT.functionLabel }}
                            </a>
                        </h1>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="main">
        <div class="uk-grid uk-grid-collapse">
            <div class="menu uk-width-medium-2-10" v-bind:class="{'active': MENU.active}">
                <div class="menu-block">
                    <ul class="menu-items">
                        <li class="menu-items-item" v-on:click="page('/profile')" v-bind:class="{'active': view[0] === 'profile'}">
                            <h1 class="menu-subtitle uk-padding-remove">登录为</h1>
                            <h2 class="uk-h2 uk-margin-remove" style="line-height: 2;">Benjamin Shi</h2>
                        </li>
                    </ul>
                </div>
                <div class="menu-block">
                    <h2 class="menu-subtitle">页面</h2>
                    <ul class="menu-items">
                        <li class="menu-items-item" v-bind:class="{'active': view === 'page'}">
                            首页管理
                        </li>
                    </ul>
                </div>
                <div class="menu-block">
                    <h2 class="menu-subtitle">文章</h2>
                    <ul class="menu-items">
                        <li class="menu-items-item" v-on:click="page('/posts')" v-bind:class="{'active': view[0] === 'posts' && view[1] === undefined}">
                            所有文章
                        </li>
                        <li class="menu-items-item" v-on:click="page('/posts/compose')" v-bind:class="{'active': view[0] === 'posts' && view[1] === 'compose'}">
                            写文章
                        </li>
                        <li class="menu-items-item" v-on:click="page('/posts/columns')" v-bind:class="{'active': view[0] === 'posts' && view[1] === 'columns'}">
                            栏目管理
                        </li>
                        <li class="menu-items-item" v-on:click="page('/posts/tags')" v-bind:class="{'active': view[0] === 'posts' && view[1] === 'tags'}">
                            标签管理
                        </li>
                    </ul>
                </div>
                <div class="menu-block">
                    <h2 class="menu-subtitle">用户</h2>
                    <ul class="menu-items">
                        <li class="menu-items-item" v-on:click="page('/users')" v-bind:class="{'active': view[0] === 'users' && view[1] === undefined}">
                            所有用户
                        </li>
                        <li class="menu-items-item" v-on:click="page('/users/nodes')" v-bind:class="{'active': view[0] === 'users' && view[1] === 'nodes'}">
                            节点
                        </li>
                        <li class="menu-items-item" v-on:click="page('/users/roles')" v-bind:class="{'active': view[0] === 'users' && view[1] === 'roles'}">
                            角色
                        </li>
                    </ul>
                </div>
            </div>
            <div class="content uk-width-medium-8-10 uk-width-1-1">
                <div v-bind:is="view[0].toUpperCase()">
                </div>
            </div>
        </div>
    </div>
</body>
<script>

    Vue.component("PROFILE", function(resolve, reject) {
        $.ajax("/templates/Admin/profile.html").done(function(data) {
            resolve({
                template: data,
                data: function() {
                    return app.$data;
                }
            });
        }).fail(function(xhr) {
            reject();
        });
    });

    Vue.component("POSTS", function(resolve, reject) {
        $.ajax("/templates/Admin/posts.html").done(function(data) {
            resolve({
                template: data,
                data: function() {
                    return app.$data;
                },
                ready: function() {
                    app.pullPosts();

                    editor = new Simditor({
                        textarea: $("#textarea"),
                        pasteImage: true,
                        imageButton: ["upload", "external"],
                        upload: {
                            url: "/api/posts",
                            params: null
                        },
                        toolbarFloat: true,
                        toolbarFloatOffset: 50,
                    });

                    autosaveTimer = setInterval(app.localSave, 30000);
                    $(window).unload(app.localSave);

                    app.restoreSave();
                },
                beforeDestroy: function() {
                    app.localSave();
                },
                methods: $.extend(app.$options.methods, {
                    onTagSelected: function() {
                        app.POSTS.filterByTags.push(app.POSTS.tagSelected);
                        app.POSTS.tagSelected = "";
                    },
                    addTag: function() { //添加
                        var text = app.POSTS.COMPOSE.tag.trim();
                        if(app.POSTS.COMPOSE.tags.indexOf(text) === -1 && text !== "") {
                            app.POSTS.COMPOSE.tags.push(text);
                            app.POSTS.COMPOSE.tag = "";
                        }
                    },
                    removeTag: function(i) { //删除COMPOSE界面的tag
                        app.POSTS.COMPOSE.tags.splice(i, 1);
                    },
                }),
                filters: {
                    postFilter: function(i) {
                        return i.filter(function(j) {
                            for(tag of app.POSTS.filterByTags) {
                                if(tag === "") {
                                    continue;
                                }
                                if(j.tags.indexOf(tag) === -1) {
                                    return false;
                                }
                            }
                            if(app.POSTS.filterByColumn === "") {
                                return true;
                            } else {
                                if(app.POSTS.filterByColumn !== j.column) {
                                    return false;
                                }
                                return true;
                            }
                        })
                    }
                }
            });
        }).fail(function(xhr) {
            reject();
        });
    });

    Vue.component("USERS", function(resolve, reject) {
        $.ajax("/templates/Admin/users.html").done(function(data) {
            resolve({
                template: data,
                data: function() {
                    return app.$data;
                }
            });
        }).fail(function(xhr) {
            reject();
        });
    });

    $(document).ready(function() {
        app = new Vue({
            el: "#app",
            data: {
                // data
                views: {
                    profile: {
                        index: "我"
                    },
                    posts: {
                        index: "文章",
                        compose: "写文章",
                        tags: "标签",
                        columns: "栏目"
                    },
                    users: {
                        index: "用户",
                        nodes: "节点",
                        roles: "角色"
                    }
                },

                view: ["profile"], // view chain
                session: {
                    username: "Benjamin Shi",
                    lastLoginTime: new Date(),
                    tags: ["管理员", "读写", "长者", "希拉里支持者"]
                },
                state: {
                    changingPasswords: false,
                    changingEmail: false
                },
                posts: [],
                columns: ["希拉里", "川普", "希拉里去死", "川普去死", "Everyone Sucks"],
                tags: ["希拉里", "川普", "希拉里去死", "川普去死", "Everyone Sucks"],

                // view labels and properties
                HEADER: {
                    CONTENT: {
                        heading: "我",
                        back: "设置"
                    }
                },
                MENU: {
                    active: false, // menu's state on small sized device
                },
                PROFILE: {
                },
                POSTS: {
                    tag: "",
                    COMPOSE: {
                        title: "",
                        content: "",
                        column: "",
                        tags: [],
                        lastModificationTime: 0,
                    },
                    orderBy: "lastModificationTime",
                    order: 1, // 1(true) for small to big; 0(false) for big to small
                    filterByColumn: "",
                    filterByTags: []
                },
                USERS: {
                }
            },
            methods: {
                page: page,
                pullPosts: function() {
                    $.ajax({
                        url: "/api/News",
                        contentType: "application/json",
                        dataType: "json",
                    }).done(function(data) {
                        //data = JSON.parse(data);
                        console.log(data);
                        for(i of data) {
                            app.posts.push({
                                id: i.id,
                                author: i.author,
                                title: i.title,
                                outline: i.outline,
                                column: i.category,
                                tags: i.tags,
                                lastModificationTime: i.postTime,
                                editable: i.editable
                            })
                        }
                    })
                },
                createPost: function() {
                    $.ajax({
                        url: "/api/News",
                        type: "post",
                        data: json.stringify({
                            category: app.POSTS.COMPOSE.column,
                            tags: app.POSTS.COMPOSE.tags,
                            title: app.POSTS.COMPOSE.title,
                            detail: app.POSTS.COMPOSE.content
                        })
                    }).fail(function(status, xhr) {
                        alert("未成功。");
                    });
                },
                pushPost: function(id) {
                    app.localSave();
                    i = app.POSTS.COMPOSE;
                    $.ajax({
                        url: "/api/News/" + id,
                        type: "put",
                        contentType: "application/json",
                        dataType: "json",
                        data: {
                            category: i.column,
                            tags: i.tags,
                            title: i.title,
                            detail: i.content,
                        }
                    }).fail(function(status, xhr) {
                        alert("未成功。")
                    })
                },
                pullPost: function(id) {
                    $.ajax({
                        url: "/api/News" + id,
                        contentType: "application/json",
                        dataType: "json",
                    }).done(function(data) {
                        //data = JSON.parse(data);
                        var i = data;
                        return {
                            id: i.id,
                            author: i.author,
                            title: i.title,
                            outline: i.outline,
                            column: i.category,
                            tags: i.tags,
                            lastModificationTime: i.postTime,
                            editable: i.editable
                        }
                    })
                },
                deletePost: function(id) {
                    $.ajax({
                        url: "/api/News/" + id,
                        type: "delete",
                        contentType: "application/json",
                        dataType: "json",
                    }).fail(function(status, xhr) {
                        alert("未成功。")
                    })
                },
                pullTags: function() {
                    $.ajax({
                        url: "/api/News/Tags",
                        contentType: "application/json",
                        dataType: "json",
                    }).done(function(data) {
                        for(i of data) {
                            app.tags.push(i.name);
                        }
                    });
                },
                postTag: function(item, name) {
                    $.ajax({
                        url: "/api/News/Tags",
                        contentType: "application/json",
                        dataType: "json",
                    }).done(function(data) {
                        var tags = data;
                        tags.filter(function(x) {
                            if(x.name === item) {
                                $.ajax({
                                    url: "/api/News/Tags/" + x.id,
                                    contentType: "application/json",
                                    dataType: "json",
                                    data: {
                                        name: name,
                                    }
                                }).done(function(data) {
                                });
                            }
                        })
                    });
                };
                restoreSave: function() {
                    app.POSTS.COMPOSE = JSON.parse(localStorage["/posts/compose"]);
                    editor.setValue(app.POSTS.COMPOSE.content);
                },
                localSave: function() { // 保存草稿至LocalStorage
                    app.POSTS.COMPOSE.lastModificationTime = Date.now() / 1000;
                    app.POSTS.COMPOSE.content = editor.getValue();
                    localStorage["/posts/compose"] = JSON.stringify(app.POSTS.COMPOSE);
                },
                localEdit: function(i) { // 从文章列表里选择编辑一篇文章
                    if(app.POSTS.COMPOSE.content) {
                        if(confirm("您有未发布的文章。是否放弃草稿？")) {
                            post = app.pullPost(i.id);
                            app.POSTS.COMPOSE = post;
                        }
                    }
                },
            },
        });

        page("*", function(ctx, next) {
            app.MENU.active = false;
            next();
        });

        page("/dashboard/", function(ctx, next) {
            page("/profile");
        });

        page("/dashboard/profile", function(ctx, next) {
            app.view = ["profile"];
            app.HEADER.CONTENT.heading = "我";
        });

        page("/dashboard/posts", function(ctx, next) {
            app.view = ["posts"];
            app.HEADER.CONTENT.heading = "文章";
        });

        page("/dashboard/posts/:v", function(ctx, next) {
            app.view = ["posts", ctx.params.v];
            app.HEADER.CONTENT.heading = app.views.posts[ctx.params.v];
        });

        page("/dashboard/users", function(ctx, next) {
            app.view = ["users"];
        });

        page("/dashboard/users/:v", function(ctx, next) {
            app.view = ["users", ctx.params.v]
            app.HEADER.CONTENT.heading = app.views.users[ctx.params.v];
        });

        page.start();
    });

    //page.base("/dashboard");
</script>
</html>